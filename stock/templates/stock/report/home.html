{% extends 'users/base.html' %}
{% load custom_templates %}

{% block content %}
<div class="container-fluid p-3">
  <div class="row">
      <div class="col text-center">
          <h3>Stock Report Page</h3>
      </div>
  </div>
  <div class="row mt-2">
      <div class="col-3 bg-light">
        <!-- <li class="list-group-item"> -->
          <!-- Button trigger modal -->
          <!-- <a href="#" data-toggle="modal" data-target="#stockAddModal">
              Fix Date
          </a> -->
      <!-- </li> -->
      <li class="list-group-item">
        <a href="#" 
        data-toggle="modal" 
        data-target="#stockReport"><i class="fa fa-vcard text-danger"></i> Daily Report</a>
      </li>
      <li class="list-group-item">
        <a href="{% url 'stock-report-all-products' %}">Products</a>
      </li>
        {% now 'Y' as current_year %}
        <li class="list-group-item"><a href="{% url 'stock-month' current_year %}">{{current_year}}</a></li>
        <li class="list-group nav-item dropdown">
          <a class="nav-link dropdown-toggle" 
          data-toggle="dropdown"
          href="#">Monthly</a> 
          <ul class="dropdown-menu">
            {% for month in months %}
            <li class="dropdown-item"><a href="{% url 'stock-month' month %}">{{month}}</a></li>
            {% endfor %}
          </ul>
        </li>
        <hr>
        <ul class="list-group list-group-flush">
          <li class="list-group nav-item dropdown">
            <a class="nav-link dropdown-toggle" 
            data-toggle="dropdown"
            href="#">Sources</a> 
            <ul class="dropdown-menu">
              {% for source in sources %}
              <li class="dropdown-item"><a href="{% url 'stock-report-source' source %}">{{source}}</a></li>
              {% endfor %}
            </ul>
          </li>
          <hr class="dropdown-divider">
          <!-- <li class="list-group nav-item dropdown">
            <a class="nav-link dropdown-toggle" 
            data-toggle="dropdown"
            href="#">Bulk Add</a> 
            <ul class="dropdown-menu">
              {% for source in sources %}
              <li class="dropdown-item"><a href="{% url 'stock-report-add' source %}" disabled>{{source}}</a></li>
              {% endfor %}
            </ul>
          </li>
          <li class="list-group nav-item dropdown">
            <a class="nav-link dropdown-toggle" 
            data-toggle="dropdown"
            href="#">Bulk Edit</a> 
            <ul class="dropdown-menu">
              {% for source in sources %}
              <li class="dropdown-item"><a href="{% url 'stock-report-update' source %}">{{source}}</a></li>
              {% endfor %}
            </ul> -->
          <!-- </li> -->
          <li class="list-group-item">
              <a href="{% url 'product-home' %}"><i class="fa fa-reply"></i> Return</a>
          </li>
        </ul>
      </div>
      <div class="col-9">
        <h5 class="text-italics text-left">{{msg}}: {{current_date|date:'d-M-Y'}}</h5>
        {% if not obj %}
        <h6 class="ml-5">No Record Found 
          <i class="fa fa-exclamation text-danger"></i>
          <i class="fa fa-exclamation text-danger"></i>
          <i class="fa fa-exclamation text-danger"></i>
        </h6>
        {% else %}
        {% if grand_total|first != 0 %}
        
        <div class="row mb-3">
          <div class="col">
            <div class="accordion" id="accordionExample">
              <div class="card">
                <div class="card-header" id="headingOne">
                  <h2 class="mb-0">
                    <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                      <h6>Grand Total: Quantity: {{grand_total|first}} and Value: N{{grand_total|array:2|floatformat:'2g'}}</h6>
                    </button>
                  </h2>
                </div>
            
                <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                  <div class="card-body">
                    <table class="table table-responsive">
                      <thead>
                        <tr class="text-right">
                          <th class="text-left">Source</th>
                          <th>Qty</th>
                          <th>Value</th>
                          <th>%</th>
                          <th>Sellout</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for dict_object in source_total %}
                        <tr class="text-right">
                          <td class="text-left">{{dict_object.source}}</td>
                          <td>{{dict_object.qty}}</td>
                          <td>{{dict_object.value|floatformat:'2g'}}</td>
                          {% with grand_total|array:2 as gtl %}
                          <td>{{dict_object.value|div:gtl|multiply:100|floatformat:'2g'}}</td>
                          {% endwith %}
                          <td>{{dict_object.sellout}}</td>
                        </tr>
                        {% endfor%}
                      </tbody>
                    </table>
                    
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
        
        {% endif %}

        <div class="row">
          {% for source in obj %}
          <div class="col">
              <table class="table table-responsive">
                {% with source|first as first_source %}
                <legend class="text-danger">{{first_source.product.source}}</legend>
                {% endwith %}
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-right">Cost</th>
                    <th class="text-right">Balance</th>
                    <th class="text-right">Value</th>
                    <th class="text-right">Selling</th>
                    <th class="text-right">Sellout</th>
                    <th class="text-right">Value</th>
                  </tr>
                </thead>
                <tbody>
                  
                  {% for item in source %}
                  <tr>
                    <td><a href="{% url 'product-ext-update' item.pk %}">{{item.product}}</a></td>
                    <td class="text-right">{{item.cost_price.amount}}</td>
                    <td class="text-right">{{item.stock_value}}</td>
                    <td class="text-right">{{item.value|floatformat:'2g'}}</td>
                    <td class="text-right">{{item.selling_price.amount}}</td>
                    <td class="text-right">{{item.sell_out}}</td>
                    <td class="text-right">{{item.sell_out|multiply:item.selling_price.amount}}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="text-danger text-right">
                    <td colspan="2">Total</td>
                    <td>{{totals|array:forloop.counter|array:1}}</td>
                    <td>{{totals|array:forloop.counter|array:2|floatformat:'2g'}}</td>
                    <td>**</td>
                    <td>{{totals|array:forloop.counter|array:3}}</td>
                    
                  </tr>
                </tfoot>
              </table>
          </div>
          
          {% endfor %}
        </div>
        {% endif %}      
      </div>
  </div>
</div>  


<!-- Stock report Modal -->
<div class="modal fade" id="stockReport" tabindex="-1" aria-labelledby="stockReportTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stockReportTitle">Stock Report - Select Date</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="." method="GET">
          <div class="modal-body">
              <div class="form-group">
                  <label class="form-label" for="#">Pick a Date</label>
                  <input id="stockReportInput" class="form-control" type="date" name="reportDate" onchange="reportDateFunc()">
              </div>
              <div class="form-group form-check ml-2 mb-0">
                <input id="checkPDF" type="checkbox" class="form-check-input" name="reportPDF">
                <label class="form-check-label" for="checkPDF">Report in PDF</label>
              </div>   
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> 
              <button id="btnReportOK" type="submit" class="btn btn-info" disabled>OK</button>        
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Stock add Modal -->
<div class="modal fade" id="stockAddModal" tabindex="-1" aria-labelledby="stockAddModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stockUpdateModalLabel">Stock Report - Change Date</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="." method="GET">
          <div class="modal-body">
              <div class="form-group">
                  <label class="form-label" for="">Pick a Date</label>
                  <input id="stockAddInput" class="form-control" type="date" name="theDate" onchange="addFunc()">
              </div>   
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button id="btnAdd" type="submit" class="btn btn-primary" disabled>Fix Date</button>           
          </div>
      </form>
    </div>
  </div>
</div>



<script>

    function reportDateFunc() {
      
      if (document.getElementById('stockReportInput').value == '') {
          document.getElementById('btnReportOK').disabled = true;
      } else {
          document.getElementById('btnReportOK').disabled = false;
      }  
    }

    function addFunc() {
      
      if (document.getElementById('stockAddInput').value == '') {
          document.getElementById('btnAdd').disabled = true;
          console.log('true')
      } else {
          document.getElementById('btnAdd').disabled = false;
          console.log(false)
      }  
    }

    function reportFunc() {
      
      if (document.getElementById('stockReportInput').value == '') {
          document.getElementById('btnReport').disabled = true;
      } else {
          document.getElementById('btnReport').disabled = false;
      }  
    }
</script>
{% endblock %}