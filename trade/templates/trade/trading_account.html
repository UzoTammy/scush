{% extends 'users/base.html' %}
{% load custom_templates %}

{% block content %}
<div class="container-fluid">
    
    <div class="jumbotron text-white" style="background-color:rgb(18, 51, 82);">
        <h1 class="display-5">Trading, Profit & Loss Account for {{ monthly}}</h1>
        <p class="lead">It is a final account that gives idea about profitability and financial position
            to its management, owners and interested parties.
        </p>
        <hr class="my-3">
        <p>The Net Profit {{np_bool|yesno:'increased, decreased'}} by 
            {{np_percent|abs}}% 
            with {{expense_bool|yesno:'an additional, a reduced'}} expenses of {{N}}{{expense_value|abs|floatformat:'2g'}} over the previous month.
            The GP ratio is {{gp_ratio|floatformat:'3'}}%, 
            the Landing Cost ratio is {{lc_ratio|floatformat:'3'}}%, while the Administrative Cost ratio is {{ac_ratio|floatformat:'3'}}%.
        </p>
    </div>
    <div class="row mb-3">
        <div class="col-md-4 text-center">
            <table class="table table-sm" data-toggle="table">
                <caption>Trade</caption>
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Sales</th>
                        <th>Purchase</th>
                        <th>Gross Profit</th>
                        <th>Net Profit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in dataset %}
                    <tr>
                        <th>{{record.month|slice:':3'}}</th>
                        <th>{{record.sales.amount|floatformat:'2g'}}</th>
                        <th>{{record.purchase.amount|floatformat:'2g'}}</th>
                        <th>{{record.gross_profit.amount|floatformat:'2g'}}</th>
                        <th>{{record.net_profit|floatformat:'2g'}}</th>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>    
        <div class="col-md-4 text-center">
            <table class="table table-sm" data-toggle="table">
                <caption><span class="text-danger">Expenses</span> & <span class="text-success">Income</span></caption>
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>D. Expenses</th>
                        <th>I. Expenses</th>
                        <th>D. Income</th>
                        <th>I. Income</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in dataset %}
                    <tr>
                        <th>{{record.month|slice:':3'}}</th>
                        <th>{{record.direct_expenses.amount|floatformat:'2g'}}</th>
                        <th>{{record.indirect_expenses.amount|floatformat:'2g'}}</th>
                        <th>{{record.direct_income.amount|floatformat:'2g'}}</th>
                        <th>{{record.indirect_income.amount|floatformat:'2g'}}</th>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>        
        </div>
        <div class="col-md-4 text-center">
            <table id="tab" class="table table-sm" data-toggle="table">
                <caption>Ratios</caption>
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Sales</th>
                        <th>Purchase</th>
                        <th>Gross</th>
                        <th>Trade</th>
                        <th>Margin</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in dataset %}
                    
                    <tr>
                        <th>{{record.month|slice:':3'}}</th>
                        <th>{{record.sales_ratio|dividedby:10000|floatformat:'3'}}</th>
                        <th>{{record.purchase_ratio|dividedby:10000|floatformat:'3'}}</th>
                        <th>{{record.gross_ratio|dividedby:10000|floatformat:'3'}}</th>
                        <th>{{record.trade_ratio|dividedby:10000|floatformat:'3'}}</th>
                        <th class="text-secondary">{{record.gross_margin_ratio|dividedby:10000|floatformat:'3'}}
                            {% if forloop.counter != 1 %}
                            {% with dataset|array:forloop.counter0 as previous %}
                                {% with previous.gross_margin_ratio as previous_value %}
                                    {% if record.gross_margin_ratio > previous_value %}
                                        <i class="fa fa-caret-up text-success" ></i>
                                    {%else%}
                                    <i class="fa fa-caret-down text-danger" ></i>
                                    {%endif%}
                                {% endwith %}
                            {% endwith %}
                            {%else%}
                            <i class="fa fa-minus text-warning"></i>
                            {% endif %}
                        </th>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
     <div class="row">
               <!-- body of page -->
        <div class="col">
            <div class="row">
                {% if monthly %} 
                
                {% for record in recordset %}
                
                <div class="col-md-4 mt-2">    
                    <ul class="list-group">
                        <li class="list-group-item list-group-item-info text-center">{{record.heading}}</li>
                        <li class="list-group-item">
                            <p>Opening Stock: {{record.opening_stock.amount|floatformat:'2g'}}</p> 
                            <p>Purchases: {{record.purchase|floatformat:'2g'}}</p>
                            <p>Direct Expenses: {{record.direct_expenses|floatformat:'2g'}}</p>
                            <p>Gross Profit: {{record.gross_profit|floatformat:'2g'}}</p>    
                        </li>

                        <li class="list-group-item list-group-item-secondary text-right">
                            Total: {{record.first_total|floatformat:'2g'}}
                        </li>
                        <li class="list-group-item">
                            <p>Sales: {{record.sales|floatformat:'2g'}}</p> 
                            <p>Direct Income: {{record.direct_income|floatformat:'2g'}}</p>
                            <p>Closing Stock:{{record.closing_stock|floatformat:'2g'}}</p>
                        </li>
                        <li class="list-group-item list-group-item-secondary text-right">Total: {{record.second_total|floatformat:'2g'}}</li>
                        
                        <li class="list-group-item"> 
                            <p>Indirect Expenses: {{record.indirect_expenses|floatformat:'2g'}}</p>
                            <p>Net Profit: {{record.net_profit|floatformat:'2g'}}</p> 
                            <p>Indirect Income: {{record.indirect_income|floatformat:'2g'}}</p> 
                        </li>
                        <li class="list-group-item">Gross Margin: {{record.percent_margin|floatformat:'3'}}%
                            {% if record.gross_margin_arrow %}
                                <i class="fa fa-long-arrow-up text-success"></i>
                            {% elif record.gross_margin_arrow == False %}
                                <i class="fa fa-long-arrow-down text-danger"></i>
                            {% else %}{% endif %}
                        </li>
                        <li class="list-group-item">Total Expenses: {{record.expenses|floatformat:'2g'}}</li>
                        
                        <li class="list-group-item">
                            Percent Expenses WRT
                            <ul>
                                <li>Sales: {{record.percent_sales|floatformat:'3'}}%
                                    {% if record.sales_arrow %}
                                        <i class="fa fa-long-arrow-up text-danger"></i>
                                    {% elif record.sales_arrow == False %}
                                        <i class="fa fa-long-arrow-down text-success"></i>
                                    {% else %}{% endif %}
                                </li>
                                <li>Gross: {{record.percent_gross|floatformat:'3'}}%
                                    {% if record.gross_arrow %}
                                        <i class="fa fa-long-arrow-up text-danger"></i>
                                    {% elif record.gross_arrow == False %}
                                        <i class="fa fa-long-arrow-down text-success"></i>
                                    {% else %}{% endif %}
                                </li> 
                                <li>Purchase: {{record.percent_purchase|floatformat:'3'}}%
                                    {% if record.purchase_arrow %}
                                        <i class="fa fa-long-arrow-up text-danger"></i>
                                    {% elif record.purchase_arrow == False %}
                                        <i class="fa fa-long-arrow-down text-success"></i>
                                    {% else %}{% endif %}
                                </li>
                            </ul> 
                        </li>
                        
                    </ul>
                </div>
                {% endfor %}
                {% else %}
                    <div class="col mt-2">
                        <h3>No Record Available</h3>
                    </div>
                {% endif %}
                
            </div>
        </div>
    </div> 
    
    <div class="row">
        <div class="col-9 mt-2">
            <form class="form-inline">
                <div class="form-group mb-2 mr-2">
                    <select type="text" name="year" class="form-control" placeholder="year">
                        <option value="2021"><--2021--></option>
                        <option value="2020"><--2020--></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-outline-primary mb-2">OK</button>
            </form>
        </div>
        
        <div class="col-3 text-right">
            <a class="btn btn-dark mt-2" href="{% url 'trade-home' %}"><i class="fa fa-reply"></i></a>
        </div>
    </div>
<script>
    
    var row = $(this).getElementById('tab').closest('tr')
    var prev = row.prev()
    console.log(prev)
</script>
{% endblock content%}